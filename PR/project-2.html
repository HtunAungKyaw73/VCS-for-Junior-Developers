<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Storage To-Do List</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#4F46E5', /* Indigo-600 */
                        'primary-light': '#EEF2FF', /* Indigo-50 */
                        'task-bg': '#F9FAFB', /* Gray-50 */
                        'mock-bg': '#FFFBEB', /* Amber-50 for mock data */
                    }
                }
            }
        }
    </script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #F3F4F6; /* Light gray background */
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .task-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .task-list-container::-webkit-scrollbar-thumb {
            background-color: #CBD5E1; /* Slate-300 */
            border-radius: 4px;
        }
        .task-list-container::-webkit-scrollbar-track {
            background: #F3F4F6; /* Gray-100 */
        }
        /* Smooth transition for tasks */
        .task-item {
            transition: all 0.3s ease-in-out;
        }
        .completed-text {
            text-decoration: line-through;
            color: #6B7280; /* Gray-500 */
        }
    </style>
</head>
<body class="flex justify-center py-10 px-4">

    <!-- Main Application Container -->
    <div class="w-full max-w-xl bg-white rounded-3xl shadow-2xl p-6 md:p-8 lg:p-10">

        <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">
            <span class="text-primary-blue">Task</span>Master
        </h1>
        <p class="text-xs text-gray-400 text-center mb-6">Tasks are saved locally in your browser.</p>
        
        <!-- Add New Task Section -->
        <div class="flex space-x-3 mb-8">
            <input
                type="text"
                id="taskInput"
                placeholder="What needs to be done?"
                class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-blue transition duration-150"
            >
            <button
                id="addTaskButton"
                class="bg-primary-blue text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition duration-150 active:scale-[0.98]"
            >
                Add
            </button>
        </div>

        <!-- Task List and Status -->
        <div id="statusMessage" class="text-center text-gray-500 text-lg py-4">
            Loading tasks...
        </div>

        <!-- Task List Container -->
        <div id="listContainer" class="task-list-container space-y-3 max-h-96 overflow-y-auto">
            <!-- Tasks will be injected here by JavaScript -->
        </div>

    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        
        // --- Configuration and State ---
        const LOCAL_STORAGE_KEY = 'taskList';

        // DOM Elements
        const taskInput = document.getElementById('taskInput');
        const addTaskButton = document.getElementById('addTaskButton');
        const listContainer = document.getElementById('listContainer');
        const statusMessage = document.getElementById('statusMessage');

        // --- Local Storage Helpers ---
        function getTasksFromStorage() {
            try {
                const tasksJson = localStorage.getItem(LOCAL_STORAGE_KEY);
                return tasksJson ? JSON.parse(tasksJson) : [];
            } catch (e) {
                console.error("Error loading tasks from localStorage:", e);
                return [];
            }
        }

        function saveTasksToStorage(tasks) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
            } catch (e) {
                console.error("Error saving tasks to localStorage:", e);
            }
        }

        /**
         * Fetches a small set of mock tasks from JSONPlaceholder.
         * @returns {Array} List of mock task objects.
         */
        async function fetchInitialTodos() {
            console.log("Fetching initial todos from JSONPlaceholder...");
            try {
                // Fetch first 5 items
                const response = await fetch('https://jsonplaceholder.typicode.com/todos?_limit=5');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                return data.map(item => ({
                    // Use a temporary mock ID; these tasks cannot be modified/saved locally
                    id: `mock-${item.id}`,
                    text: item.title,
                    completed: item.completed,
                    // Use a unique negative number for sorting mock data to the bottom
                    timestamp: item.id * -1 
                }));
            } catch (error) {
                console.error("Failed to fetch mock data:", error);
                return [];
            }
        }


        // --- CRUD Operations ---

        function addTask() {
            const text = taskInput.value.trim();
            if (text === "") return;

            const tasks = getTasksFromStorage();
            
            // Create a new task with a unique local ID
            const newTask = {
                id: Date.now().toString(),
                text: text,
                completed: false,
                timestamp: Date.now()
            };

            tasks.push(newTask);
            saveTasksToStorage(tasks);
            taskInput.value = ''; // Clear input on success
            renderTodos(tasks);
        }

        function toggleTaskCompletion(id, completed) {
            let tasks = getTasksFromStorage();
            
            // Cannot update mock tasks
            if (id.startsWith('mock-')) {
                console.warn(`Cannot update mock task: ${id}`);
                return;
            }

            tasks = tasks.map(task => 
                task.id === id ? { ...task, completed: !completed } : task
            );
            
            saveTasksToStorage(tasks);
            renderTodos(tasks);
        }

        function deleteTask(id) {
            
            if (id.startsWith('mock-')) {
                // For mock tasks, just remove from UI since they aren't in storage
                document.querySelector(`li[data-id="${id}"]`)?.remove();
                return;
            }

            let tasks = getTasksFromStorage();
            
            // Filter out the task by ID
            tasks = tasks.filter(task => task.id !== id);
            
            saveTasksToStorage(tasks);
            renderTodos(tasks);
        }

        // --- Data Loading and Rendering ---

        async function loadTasks() {
            let tasks = getTasksFromStorage();
            let finalTodos = [...tasks];

            // If local storage is empty, fetch mock data
            if (tasks.length === 0) {
                statusMessage.textContent = "Loading sample tasks from API...";
                const mockTodos = await fetchInitialTodos();
                
                if (mockTodos.length > 0) {
                    // Combine mock data with empty local storage array
                    finalTodos = mockTodos.concat(finalTodos); 
                    statusMessage.textContent = "Welcome! Displaying sample tasks from JSONPlaceholder (not saved). Add a task above to save permanently.";
                    statusMessage.classList.remove('hidden');
                } else {
                    statusMessage.textContent = "You have no tasks! Start by adding one above.";
                    statusMessage.classList.remove('hidden');
                }
            } else {
                statusMessage.classList.add('hidden');
            }
            
            // Sort tasks: Uncompleted > Completed. Within same group, sort by newest first (highest timestamp).
            finalTodos.sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                return b.timestamp - a.timestamp;
            });

            renderTodos(finalTodos);
        }

        function renderTodos(todos) {
            listContainer.innerHTML = ''; // Clear existing list
            
            if (todos.length === 0 && getTasksFromStorage().length === 0) return; 

            todos.forEach(task => {
                const isMock = task.id.startsWith('mock-');
                
                // Create the list item element
                const listItem = document.createElement('li');
                listItem.setAttribute('data-id', task.id); 
                
                let bgColorClass = isMock ? 'bg-mock-bg border-yellow-200' : 'bg-white border-gray-100';
                
                if (task.completed) {
                    bgColorClass = isMock ? 'bg-mock-bg opacity-70 border-yellow-200' : 'bg-primary-light border-gray-100';
                }

                listItem.className = `task-item flex items-center justify-between p-4 rounded-xl shadow-sm cursor-pointer border transition duration-150 ${bgColorClass} hover:shadow-md`;
                
                // Task text and checkbox
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex items-center flex-grow min-w-0';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.completed;
                checkbox.className = 'w-5 h-5 text-primary-blue bg-gray-100 border-gray-300 rounded focus:ring-primary-blue cursor-pointer';
                checkbox.disabled = isMock; // Disable checkbox for mock data
                checkbox.addEventListener('change', () => toggleTaskCompletion(task.id, task.completed));
                
                const textSpan = document.createElement('span');
                
                let textContent = task.text;
                if (isMock) {
                    textContent += " (Sample)";
                }

                textSpan.textContent = textContent;
                textSpan.className = `ml-4 text-lg font-medium truncate ${task.completed ? 'completed-text' : 'text-gray-900'}`;
                
                contentDiv.appendChild(checkbox);
                contentDiv.appendChild(textSpan);
                
                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-gray-400 hover:text-red-600 transition duration-150 p-2 rounded-full hover:bg-gray-100 flex-shrink-0';
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    <path d="M11 6h3.693l-1.333-2.666A2 2 0 0011.693 3H8.307a2 2 0 00-1.666 1.334L5.307 6H9z" fill="none"/>
                </svg>`;
                deleteButton.title = 'Delete Task';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    deleteTask(task.id);
                });

                listItem.appendChild(contentDiv);
                listItem.appendChild(deleteButton);
                listContainer.appendChild(listItem);
            });
        }

        // --- Setup Event Listeners ---

        function setupListeners() {
            addTaskButton.addEventListener('click', addTask);
            
            taskInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
        }

        // Initialize everything on window load
        window.onload = () => {
            loadTasks();
            setupListeners();
        };

    </script>
</body>
</html>